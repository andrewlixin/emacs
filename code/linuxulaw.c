#include <sys/soundcard.h>
#include <stdio.h>
#include <fcntl.h>
#include <sys/ioctl.h>
static unsigned char ulaw_dsp[] = {
    3,    7,   11,   15,   19,   23,   27,   31,
    35,   39,   43,   47,   51,   55,   59,   63,
    66,   68,   70,   72,   74,   76,   78,   80,
    82,   84,   86,   88,   90,   92,   94,   96,
    98,   99,  100,  101,  102,  103,  104,  105,
    106,  107,  108,  109,  110,  111,  112,  113,
    113,  114,  114,  115,  115,  116,  116,  117,
    117,  118,  118,  119,  119,  120,  120,  121,
    121,  121,  122,  122,  122,  122,  123,  123,
    123,  123,  124,  124,  124,  124,  125,  125,
    125,  125,  125,  125,  126,  126,  126,  126,
    126,  126,  126,  126,  127,  127,  127,  127,
    127,  127,  127,  127,  127,  127,  127,  127,
    128,  128,  128,  128,  128,  128,  128,  128,
    128,  128,  128,  128,  128,  128,  128,  128,
    128,  128,  128,  128,  128,  128,  128,  128,
    253,  249,  245,  241,  237,  233,  229,  225,
    221,  217,  213,  209,  205,  201,  197,  193,
    190,  188,  186,  184,  182,  180,  178,  176,
    174,  172,  170,  168,  166,  164,  162,  160,
    158,  157,  156,  155,  154,  153,  152,  151,
    150,  149,  148,  147,  146,  145,  144,  143,
    143,  142,  142,  141,  141,  140,  140,  139,
    139,  138,  138,  137,  137,  136,  136,  135,
    135,  135,  134,  134,  134,  134,  133,  133,
    133,  133,  132,  132,  132,  132,  131,  131,
    131,  131,  131,  131,  130,  130,  130,  130,
    130,  130,  130,  130,  129,  129,  129,  129,
    129,  129,  129,  129,  129,  129,  129,  129,
    128,  128,  128,  128,  128,  128,  128,  128,
    128,  128,  128,  128,  128,  128,  128,  128,
    128,  128,  128,  128,  128,  128,  128,  128,
};

static unsigned char dsp_ulaw[] = {
    0,    0,    0,    0,    0,    1,    1,    1,
    1,    2,    2,    2,    2,    3,    3,    3,
    3,    4,    4,    4,    4,    5,    5,    5,
    5,    6,    6,    6,    6,    7,    7,    7,
    7,    8,    8,    8,    8,    9,    9,    9,
    9,   10,   10,   10,   10,   11,   11,   11,
    11,   12,   12,   12,   12,   13,   13,   13,
    13,   14,   14,   14,   14,   15,   15,   15,
    15,   16,   16,   17,   17,   18,   18,   19,
    19,   20,   20,   21,   21,   22,   22,   23,
    23,   24,   24,   25,   25,   26,   26,   27,
    27,   28,   28,   29,   29,   30,   30,   31,
    31,   32,   33,   34,   35,   36,   37,   38,
    39,   40,   41,   42,   43,   44,   45,   46,
    47,   49,   51,   53,   55,   57,   59,   61,
    63,   66,   70,   74,   78,   84,   92,  104,
    254,  231,  219,  211,  205,  201,  197,  193,
    190,  188,  186,  184,  182,  180,  178,  176,
    175,  174,  173,  172,  171,  170,  169,  168,
    167,  166,  165,  164,  163,  162,  161,  160,
    159,  159,  158,  158,  157,  157,  156,  156,
    155,  155,  154,  154,  153,  153,  152,  152,
    151,  151,  150,  150,  149,  149,  148,  148,
    147,  147,  146,  146,  145,  145,  144,  144,
    143,  143,  143,  143,  142,  142,  142,  142,
    141,  141,  141,  141,  140,  140,  140,  140,
    139,  139,  139,  139,  138,  138,  138,  138,
    137,  137,  137,  137,  136,  136,  136,  136,
    135,  135,  135,  135,  134,  134,  134,  134,
    133,  133,  133,  133,  132,  132,  132,  132,
    131,  131,  131,  131,  130,  130,  130,  130,
    129,  129,  129,  129,  128,  128,  128,  128,
};


static int ulaw2int1[256] = {
    -32124, -31100, -30076, -29052, -28028, -27004, -25980, -24956,
    -23932, -22908, -21884, -20860, -19836, -18812, -17788, -16764,
    -15996, -15484, -14972, -14460, -13948, -13436, -12924, -12412,
    -11900, -11388, -10876, -10364,  -9852,  -9340,  -8828,  -8316,
    -7932,  -7676,  -7420,  -7164,  -6908,  -6652,  -6396,  -6140,
    -5884,  -5628,  -5372,  -5116,  -4860,  -4604,  -4348,  -4092,
    -3900,  -3772,  -3644,  -3516,  -3388,  -3260,  -3132,  -3004,
    -2876,  -2748,  -2620,  -2492,  -2364,  -2236,  -2108,  -1980,
    -1884,  -1820,  -1756,  -1692,  -1628,  -1564,  -1500,  -1436,
    -1372,  -1308,  -1244,  -1180,  -1116,  -1052,   -988,   -924,
    -876,   -844,   -812,   -780,   -748,   -716,   -684,   -652,
    -620,   -588,   -556,   -524,   -492,   -460,   -428,   -396,
    -372,   -356,   -340,   -324,   -308,   -292,   -276,   -260,
    -244,   -228,   -212,   -196,   -180,   -164,   -148,   -132,
    -120,   -112,   -104,    -96,    -88,    -80,    -72,    -64,
    -56,    -48,    -40,    -32,    -24,    -16,     -8,      0,
    32124,  31100,  30076,  29052,  28028,  27004,  25980,  24956,
    23932,  22908,  21884,  20860,  19836,  18812,  17788,  16764,
    15996,  15484,  14972,  14460,  13948,  13436,  12924,  12412,
    11900,  11388,  10876,  10364,   9852,   9340,   8828,   8316,
    7932,   7676,   7420,   7164,   6908,   6652,   6396,   6140,
    5884,   5628,   5372,   5116,   4860,   4604,   4348,   4092,
    3900,   3772,   3644,   3516,   3388,   3260,   3132,   3004,
    2876,   2748,   2620,   2492,   2364,   2236,   2108,   1980,
    1884,   1820,   1756,   1692,   1628,   1564,   1500,   1436,
    1372,   1308,   1244,   1180,   1116,   1052,    988,    924,
    876,    844,    812,    780,    748,    716,    684,    652,
    620,    588,    556,    524,    492,    460,    428,    396,
    372,    356,    340,    324,    308,    292,    276,    260,
    244,    228,    212,    196,    180,    164,    148,    132,
    120,    112,    104,     96,     88,     80,     72,     64,
    56,     48,     40,     32,     24,     16,      8,      0 };

static short int ulaw2int2[256] = {
    /* Precomputed lookup table for conversion from ulaw to 15 bit signed */
    -16062,-15550,-15038,-14526,-14014,-13502,-12990,-12478,
    -11966,-11454,-10942,-10430, -9918, -9406, -8894, -8382,
    -7998, -7742, -7486, -7230, -6974, -6718, -6462, -6206,
    -5950, -5694, -5438, -5182, -4926, -4670, -4414, -4158,
    -3966, -3838, -3710, -3582, -3454, -3326, -3198, -3070,
    -2942, -2814, -2686, -2558, -2430, -2302, -2174, -2046,
    -1950, -1886, -1822, -1758, -1694, -1630, -1566, -1502,
    -1438, -1374, -1310, -1246, -1182, -1118, -1054,  -990,
    -942,  -910,  -878,  -846,  -814,  -782,  -750,  -718,
    -686,  -654,  -622,  -590,  -558,  -526,  -494,  -462,
    -438,  -422,  -406,  -390,  -374,  -358,  -342,  -326,
    -310,  -294,  -278,  -262,  -246,  -230,  -214,  -198,
    -186,  -178,  -170,  -162,  -154,  -146,  -138,  -130,
    -122,  -114,  -106,   -98,   -90,   -82,   -74,   -66,
    -60,   -56,   -52,   -48,   -44,   -40,   -36,   -32,
    -28,   -24,   -20,   -16,   -12,    -8,    -4,    +0,
    +16062,+15550,+15038,+14526,+14014,+13502,+12990,+12478,
    +11966,+11454,+10942,+10430, +9918, +9406, +8894, +8382,
    +7998, +7742, +7486, +7230, +6974, +6718, +6462, +6206,
    +5950, +5694, +5438, +5182, +4926, +4670, +4414, +4158,
    +3966, +3838, +3710, +3582, +3454, +3326, +3198, +3070,
    +2942, +2814, +2686, +2558, +2430, +2302, +2174, +2046,
    +1950, +1886, +1822, +1758, +1694, +1630, +1566, +1502,
    +1438, +1374, +1310, +1246, +1182, +1118, +1054,  +990,
    +942,  +910,  +878,  +846,  +814,  +782,  +750,  +718,
    +686,  +654,  +622,  +590,  +558,  +526,  +494,  +462,
    +438,  +422,  +406,  +390,  +374,  +358,  +342,  +326,
    +310,  +294,  +278,  +262,  +246,  +230,  +214,  +198,
    +186,  +178,  +170,  +162,  +154,  +146,  +138,  +130,
    +122,  +114,  +106,   +98,   +90,   +82,   +74,   +66,
    +60,   +56,   +52,   +48,   +44,   +40,   +36,   +32,
    +28,   +24,   +20,   +16,   +12,    +8,    +4,    +0};

int main()
{
    int audiodev;
    FILE* au;
    FILE* out;
    
    int n=0,fmt=0,speed=8000;
    int res;

    unsigned char buffer[BUFSIZ];
    
    audiodev=open("/dev/audio",O_WRONLY);
    fmt=AFMT_U8; 
    
    res=ioctl(audiodev,SNDCTL_DSP_RESET,NULL);
    if(res)
    {
	perror("");
	exit(-1);
    }
    
    res=ioctl(audiodev,SNDCTL_DSP_SETFMT,&fmt);
    
    if(res)
    {
	perror("");
	exit(-1);
    }

    res=ioctl(audiodev,SOUND_PCM_WRITE_RATE,&speed);
    if(res)
    {
	perror("");
	exit(-1);
    }
    n=2;
    res=ioctl(audiodev,SNDCTL_DSP_STEREO,&n);
    if(res)
    {
	perror("");
	exit(-1);
    }
    n=1;
    
    res=ioctl(audiodev,SNDCTL_DSP_CHANNELS,&n);
    if(res)
    {
	perror("");
	exit(-1);
    }
    

    if(audiodev<0)
    {
	perror("");
	exit(-1);
    }

    au=fopen("whip.au","r");
    if(!au)
    {
	perror("");
	exit(-1);
    }
    fseek(au,32,SEEK_SET);
    while((n=fread(buffer,1,1,au))>0)
    {
	buffer[1]=((ulaw2int2[buffer[0]]>>8)^(signed char)0x80);
	write(audiodev,buffer+1,n); 
    }
    close(audiodev); 
    fclose(au);
}

static signed char int2ulaw(int i)
{
    /* Lookup table for fast calculation of number of bits that need shifting*/
    static short int t_bits[128] = {
	0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,
	6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
	7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7};
    int bits,logi;

    /* unrolling this condition (hopefully) improves execution speed */
    if (i < 0) {
	if ((i = (132-i)) > 0x7FFF) i = 0x7FFF;
	logi = (i >> ((bits = t_bits[i/256])+4));
	return((bits << 4 | logi) ^ 0x7F); }
    else {
	if ((i = 132+i) > 0x7FFF) i = 0x7FFF;
	logi = (i >> ((bits = t_bits[i/256])+4));
	return(~(bits << 4 | logi)); }
}
